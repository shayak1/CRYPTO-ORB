#!/bin/bash
set -euo pipefail

##########################
# CONFIG - EDIT THESE
##########################
REPO_URL="https://github.com/shayak1/CRYPTO-ORB.git"   # <-- replace with your repo
REPO_BRANCH="main"                                     # <-- replace branch if needed

TARGET_DIR="/home/ubuntu/CRYPTO-ORB"
VENV_DIR="/home/ubuntu/CRYPTO-ORB/venv"
ENV_FILE="/home/ubuntu/CRYPTO-ORB/.env"
REQ_FILE="/home/ubuntu/CRYPTO-ORB/requirements.txt"

RUN_AS_USER="ubuntu"
##########################

# ensure script is run as root
if [ "$(id -u)" -ne 0 ]; then
  echo "Run this script with sudo."
  exit 1
fi

echo "1) Updating environment..."
apt-get update -y
apt-get upgrade -y

echo "2) Installing Python + Git..."
apt-get install -y git python3 python3-venv python3-pip curl

echo "3) Creating folder ${TARGET_DIR}..."
mkdir -p "${TARGET_DIR}"
chown -R "${RUN_AS_USER}:${RUN_AS_USER}" "${TARGET_DIR}"

# Clone repository
if [ ! -d "${TARGET_DIR}/.git" ]; then
  echo "4) Cloning repository into CRYPTO-ORB..."
  sudo -u "${RUN_AS_USER}" git clone --branch "${REPO_BRANCH}" "${REPO_URL}" "${TARGET_DIR}"
else
  echo "4) Repo exists — updating..."
  sudo -u "${RUN_AS_USER}" git -C "${TARGET_DIR}" fetch --all
  sudo -u "${RUN_AS_USER}" git -C "${TARGET_DIR}" reset --hard "origin/${REPO_BRANCH}"
fi

echo "5) Setting up Python venv at ${VENV_DIR}..."
if [ ! -d "${VENV_DIR}" ]; then
  sudo -u "${RUN_AS_USER}" python3 -m venv "${VENV_DIR}"
fi

echo "6) Installing requirements (if file present)..."
sudo -u "${RUN_AS_USER}" bash -lc "
source '${VENV_DIR}/bin/activate'
python -m pip install --upgrade pip
if [ -f '${REQ_FILE}' ]; then
  pip install -r '${REQ_FILE}'
else
  echo 'requirements.txt not found — skipping.'
fi
"

echo "7) Creating .env file for API credentials..."
if [ ! -f "${ENV_FILE}" ]; then
  cat > "${ENV_FILE}" <<'EOF'
# Add your API keys here
# Example:
# BINANCE_API_KEY=your_key_here
# BINANCE_API_SECRET=your_secret_here
EOF
  chmod 600 "${ENV_FILE}"
  chown "${RUN_AS_USER}:${RUN_AS_USER}" "${ENV_FILE}"
else
  echo ".env already exists — leaving it unchanged."
  chmod 600 "${ENV_FILE}"
  chown "${RUN_AS_USER}:${RUN_AS_USER}" "${ENV_FILE}"
fi

echo "Setup complete."
echo "Your project folder: ${TARGET_DIR}"
echo "Virtual environment: ${VENV_DIR}"
echo "Env file: ${ENV_FILE}"
